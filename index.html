<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />
    <style>
        .clickable {
            cursor: pointer;
        }
    </style>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
    <div class="row">
        <form class="col s12">
            <div class="row">
                <div id="btn_cookies_usage_notification" class="input-field col s12 ">
                    <a class="waves-effect waves-light btn"><i class="material-icons right">cloud</i>Cookies Notification</a>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s8">
                    <input placeholder="Trimes endpoint url" id="input_trimes_endpoint_url" type="text" class="validate">
                    <label for="input_trimes_endpoint_url">Trimes Endpoint URL</label>
                </div>
                <div class="input-field col s4">
                    <a id="btn_trimes_endpoint_url" class="waves-effect waves-light btn"><i class="material-icons right">cloud</i>connect</a>
                    <span>
                        <label>
                            <input id="cb_auto_connect" type="checkbox" class="filled-in"/>
                            <span>Auto connect</span>
                        </label>
                    </span>
                </div>
            </div>
        </form>
        <div class="row">
            <div class="col s6 ">Main</div>
            <div class="col s6 ">Link</div>
        </div>
        <div class="row">
            <!-- main board -->
            <div id="container_main_board" class="dropdown-field col s6 trello-board-container">
                <a class='dropdown-trigger btn' href='#' data-target='dd_main_board' data-trello-type="board">Select Board</a>
                    <!-- Dropdown Structure -->
                    <ul id='dd_main_board' class='dropdown-content'></ul>
            </div>
            <!-- link board -->
            <div id="container_link_board" class="dropdown-field col s6 trello-board-container">
                <a class='dropdown-trigger btn' href='#' data-target='dd_link_board' data-trello-type="board">Select Board</a>
                <!-- Dropdown Structure -->
                <ul id='dd_link_board' class='dropdown-content'></ul>
            </div>
        </div>
        <div class="row">
            <!-- main list -->
            <div id="container_main_list" class="dropdown-field col s6 trello-list-container">
                <a class='dropdown-trigger btn' href='#' data-target='dd_main_list' data-associated-dropdown="dd_main_board" data-trello-type="list">Select List</a>
                <!-- Dropdown Structure -->
                <ul id='dd_main_list' class='dropdown-content'></ul>
            </div>
            <!-- link list -->
            <div id="container_link_list" class="dropdown-field col s6 trello-list-container">
                <a class='dropdown-trigger btn' href='#' data-target='dd_link_list' data-associated-dropdown="dd_link_board" data-trello-type="list">Select
                    List</a>
                <!-- Dropdown Structure -->
                <ul id='dd_link_list' class='dropdown-content'></ul>
            </div>
        </div>
        <div class="row">
            <!-- main card -->
            <div id="container_main_card" class="dropdown-field col s6 trello-card-container">
                <a class='dropdown-trigger btn' href='#' data-target='dd_main_card' data-associated-dropdown="dd_main_list"
                    data-trello-type="card">Select Card</a>
                <!-- Dropdown Structure -->
                <ul id='dd_main_card' class='dropdown-content'></ul>
            </div>
            <!-- link card -->
            <div id="container_link_card" class="dropdown-field col s6 trello-card-container">
                <a class='dropdown-trigger btn' href='#' data-target='dd_link_card' data-associated-dropdown="dd_link_list" data-trello-type="card">Select
                    Card</a>
                <!-- Dropdown Structure -->
                <ul id='dd_link_card' class='dropdown-content'></ul>
            </div>
        </div>
        <div class="row">
            <!-- label main checklist: parent task -->
            <div id="label_main_checklist_parent_task" class="col s6">
                Parent Task
            </div>
            <!-- label link checklist: parent task -->
            <div id="label_link_checklist_parent_task" class="col s6">
                Parent Task
            </div>
        </div>
        <div class="row">
            <!-- input main checklist: parent task -->
            <div class="input-field col s5">
                <input placeholder="parent task Trello short link" id="input_main_parent_task_url" type="text" class="validate">
                <label for="input_main_parent_task_url">Trello short url</label>
            </div>
            <div class="input-field col s1">
                <i id="action_save_main_parent_task" class="small material-icons clickable hide" data-type="save-task">save</i>
                <i id="action_open_main_parent_task" class="small material-icons clickable hide" data-type="open-task" data-target="trimes_main_parent_task">open_in_new</i>
            </div>
            <!-- input link checklist: parent task -->
            <div id="container_link_checklist_parent_task" class="col s6">
                Parent Task
            </div>
        </div>
        <div class="row">
            <!-- label main checklist: child task -->
            <div id="label_main_checklist_parent_task" class="col s6">
                Child Task(s)
            </div>
            <!-- label link checklist: child task -->
            <div id="label_link_checklist_parent_task" class="col s6">
                Child Task(s)
            </div>
        </div>
        <div class="row">
            <!-- actions for main checklist: child task -->
            <div class="input-field col s6">
                <div id="container_main_actions_child_task" class="row">
                    <div id="container_link_checklist_child_task" class="col s10">
                        <label for="template_input_main_child_task_url">Trello short url</label>
                        <input id="template_input_main_child_task_url" placeholder="child task Trello short link" type="text" class="validate">
                    </div>
                    <div id="container_link_checklist_child_task" class="col s2">
                        <i id="action_main_add_child_task" class="small material-icons clickable">add_box</i>
                    </div>
                </div>
                <div id="container_main_actions_child_task_template" class="row" data-type="child_task">
                    <div class="col s10">
                        <label for="input_main_child_task_url">Trello short url</label>
                        <input placeholder="child task Trello short link" type="text" class="validate" data-type="url">
                    </div>
                    <div class="col s2">
                        <span>
                            <label>
                                <input type="checkbox" class="filled-in clickable" data-type="done"/><span>Done</span>
                            </label>
                        </span>
                        <i class="small material-icons clickable trimes-action-open-task">open_in_new</i>
                        <i class="small material-icons clickable" data-task-type="child">delete_forever</i>
                    </div>
                </div>
            </div>
            <!-- input link checklist: child task -->
            <div class="col s6">
                <div class="row">
                    <div id="container_link_checklist_child_task" class="col s6"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- main checklist: child task -->
            <div id="container_main_checklist_child_task" class="col s6"></div>
        </div>
    </div>
    <div>
        <!-- Modal Structure -->
        <div id="modal_cookies_usage_consent" class="modal">
            <div class="modal-content">
                <h4>Cookies and Session storage notification</h4>
                <p>This site uses cookies. They are used to auto-fill some inputs on each page. We do not collect nor transfer your data to use outside of this website. By continuing to use the site, you consent to the use of these cookies.</p>
            </div>
            <div class="modal-footer">
                <a id="link_cookies_usage_consent" class="modal-close waves-effect waves-green btn-flat">Agree & Close</a>
            </div>
        </div>
    </div>
    <!--JavaScript at end of body for optimized loading-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.mjs"></script>
    <script type="module">
    import Cookies from 'https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.mjs'
    const PARENT_LIST_NAME = 'parent-task', CHILD_LIST_NAME = 'child-tasks';
    let web_socket;
    let trello_boards = {etag: "", data: []}, trello_lists = new Map(), trello_cards = new Map();
    $(document).ready(async ()=>{
        $('#btn_trimes_endpoint_url').click(async (event) => {
            if (!validateTrimesEndpointUrl()) {
                alert('Trimes Endpoint URL must not be empty!');
            }
            else {
                await connectToTrimesEndpoint();
            }
        });

        $('#input_main_parent_task_url').on('input', (event)=> {
            delay(event.target, 'slow', (args) => {
                console.log('delay complete', ...args);
                const url = String($('#input_main_parent_task_url').val()).trim();
                const old_value = $('#input_main_parent_task_url').data('old-value') || '';

                if(url !== old_value) {
                    $('#action_save_main_parent_task').removeClass('hide').addClass('show');
                } else {
                    $('#action_save_main_parent_task').removeClass('show').addClass('hide');
                }

                if (url !== '') {
                    $('#action_open_main_parent_task').removeClass('hide').addClass('show');
                } else {
                    $('#action_open_main_parent_task').removeClass('show').addClass('hide');
                }
            }, 1,2,3,4);
        });

        $('#cb_auto_connect').click(async (event) => {
            if($('#cb_auto_connect').prop('checked')){
                Cookies.set('trimesautoconnect', 'true');
                M.toast( {html: 'Auto connect enabled.' });
            } else {
                Cookies.set('trimesautoconnect', 'false');
                M.toast({ html: 'Auto connect disabled.' });
            }
        });

        $('#input_trimes_endpoint_url').click((event) => {
            validateTrimesEndpointUrl();
        });
        $('#btn_cookies_usage_notification').click((event)=>{
            resetCookiesConsent();
        });
        $('#input_trimes_endpoint_url').val(Cookies.get('cookies_trimes_endpoint_url') || '');

        $('#link_cookies_usage_consent').click((event)=>{
            consentToUseCookies();
        });

        $('.trimes-action-open-task').click((event)=>{
            if($(event.target).data('url') && $(event.target).data('url') !== ''){
                window.open($('.trimes-action-open-task').val(), $(event.target).data('target'));
            } else {
                M.toast({ html: 'Task item doesn\'t contain a value url!' });
            }
        });

        $('#action_main_add_child_task').click(async (event)=>{
            await addChildTask();
        });

        // initialize dropdowns
        $('.dropdown-trigger').dropdown({
            hover: false,
            constrainWidth: false,
            coverTrigger: false,
            onOpenStart: async (element) => { await onDropdownStart(element);}
        });

        let modal_elements = document.querySelectorAll('.modal');
        let modal_instances = M.Modal.init(modal_elements);
        let modal_cookies_usage_consent = M.Modal.getInstance($('#modal_cookies_usage_consent'));

        const delay = async (dom, duration = 'fast', callback, ...args) => {
            const du = duration === 'fast' && 200 || 600;
            if($(dom).data('in-delay')){
                 $(dom).data('in-delay', du);
            } else {
                new Promise((resolve) => {
                    $(dom).data('in-delay', du);
                    let intv = 100;
                    let interval = setInterval(() => {
                        let current_delay = Number($(dom).data('in-delay'));
                        current_delay -= intv;
                        if(current_delay < 0) {
                            clearInterval(interval);
                            $(dom).data('in-delay', null);
                            resolve(callback(args));
                        } else {
                            $(dom).data('in-delay', current_delay);
                        }
                    }, intv);
                })
            }
        };

        const verifyCookiesConsent = () => {
            console.info('called verifyCookiesConsent()');
            if (!Cookies.get('cookies_usage_consent')) {
                modal_cookies_usage_consent.open();
                return false;
            }
            return true;
        }

        const consentToUseCookies = () => {
            console.info('called consentToUseCookies()');
            Cookies.set('cookies_usage_consent', true);
        }
        const resetCookiesConsent = () => {
            console.info('called resetCookiesConsent()');
            Cookies.remove('cookies_usage_consent');
            verifyCookiesConsent();
        }

        const connectToTrimesEndpoint = async () => {
            if(!validateTrimesEndpointUrl()) {

            }
            saveInputs();
            let trimesEndpointUrl = String($('#input_trimes_endpoint_url').val());
            if(!trimesEndpointUrl.endsWith('/')){
                trimesEndpointUrl += '/';
            }
            Cookies.set('trimesendpointurl', trimesEndpointUrl);
            let wsTrimesEndpointUrl = await $.get(trimesEndpointUrl + 'wssep').done();
            console.log(wsTrimesEndpointUrl)
            if(wsTrimesEndpointUrl === 'undefined'){
                throw new Error('failed to connect to the Trimes Endpoint.');
            } else {
            web_socket = new WebSocket(wsTrimesEndpointUrl);
            web_socket.onopen = wsOnOpen;
            web_socket.onclose = wsOnClose;
            web_socket.onmessage = wsMessage;
            web_socket.onerror = wsOnError;
            }
        }

        const wsOnOpen = async (event) => {
            console.info('called wsOnOpen()');
            console.info(event);
            if(!sessionStorage.getItem('trimesapikey')) {
                let trimesApiKey = await getTrimesApiKey();
                if(trimesApiKey) {
                    sessionStorage.setItem('trimesapikey', trimesApiKey);
                }
            }
            // go through Trello Auth
            await doTrelloAuth();
            await fetchTrelloSourceBoards();
        }
        const wsOnClose = (event) => {
            console.info('called wsOnClose()');
        }
        const wsMessage = (event) => {
            console.info('called wsMessage()');
        }
        const wsOnError = (event) => {
            console.info('called wsOnError()');
        }

        const getTrimesApiKey = async (event) => {
            console.info('called getTrimesApiKey()');
            try {
                return await $.get(Cookies.get('trimesendpointurl') + 'apikey').done();
            } catch (error) {
                return null;
            }
        }

        const doTrelloAuth = async (event) => {
            console.info('called doTrelloAuth()');
            const api_key = sessionStorage.getItem('trimesapikey');
            if(!api_key) {
                console.error('Trimes API key not found.');
                return;
            }
            // Trello name space isn't available
            try {
                if(Trello) {
                    console.info('Trello library is loaded.');
                }
            } catch (error) {
                await $.getScript(`https://trello.com/1/client.js?key=${api_key}`).done();
            }

            // return JSON.parse(response);
            const auth = async () => {
                const expirations = new Map();
                expirations.set('1hour', 3600000);
                expirations.set('1day', 86400000);
                expirations.set('30day', 2592000000);
                expirations.set('never', NaN);
                const auth_expiration = '1day';
                if(Number(sessionStorage.getItem('trello_auth_expiration')) < Date.now()){
                    Trello.deauthorize();
                    sessionStorage.removeItem('trello_auth_expiration');
                }
                return new Promise((resolve, reject) => {
                    Trello.authorize({
                        type: 'popup',
                        name: 'Trimes!',
                        persist: true,
                        scope: {
                            read: true,
                            write: true,
                            account: false
                        },
                        expiration: auth_expiration,
                        success: (data) => {
                            if(!sessionStorage.getItem('trello_auth_expiration')) {
                                sessionStorage.setItem('trello_auth_expiration',
                                    Date.now() + expirations.get(auth_expiration));
                            }
                            resolve(true);
                        },
                        error: (data) => {
                            reject(data);
                        }
                    })
                });
            }
            await auth();
        }

        const fetchTrelloSourceBoards = async () =>{
            console.info('called fetchTrelloSourceBoards()');
            if(!(Trello && Trello.token())){
                console.error('Trello authorization incomplete.');
                return;
            }
            const me = await Trello.members.get('me');
            console.log(me);
            let tasks = [];
            me.idBoards.forEach((id)=>{
                console.log(id);
                tasks.push(Trello.boards.get(id));
            });

            const boards = await Promise.all(tasks);
            trello_boards = {
                etag: Date.now(),
                data: boards
            };
            console.log(trello_boards);
        }

        const fetchTrelloSourceLists = async (board_id) => {
            console.info('called fetchTrelloSourceLists()');
            if (!(Trello && Trello.token())) {
                console.error('Trello authorization incomplete.');
                return;
            }
            const lists = await Trello.rest('get', `board/${board_id}/lists`);
            const etag = Date.now();
            lists.map(list=>{
                trello_lists.set(list.id, {
                    etag: etag,
                    data: list
                });
            });
        }

        const fetchTrelloSourceCards = async (list_id) => {
            console.info('called fetchTrelloSourceCards()');
            if (!(Trello && Trello.token())) {
                console.error('Trello authorization incomplete.');
                return;
            }
            const cards = await Trello.rest('get', `lists/${list_id}/cards`);
            const etag = Date.now();
            cards.map(card => {
                trello_cards.set(card.id, {
                    etag: etag,
                    data: card
                });
            });
        }

        const loadTrelloSourceCard = async (card_id, etag = null) => {
            console.info('called loadTrelloSourceCard()');
            if (!(Trello && Trello.token())) {
                console.error('Trello authorization incomplete.');
                return;
            }

            //need reload against an etag?
            if(etag !== null) {
                let card = trello_cards.get(card_id);
                if(card && card.etag && card.etag !== etag){
                    card = {
                        etag: Date.now(),
                        data: await Trello.rest('get', `cards/${card_id}`)
                    };
                    trello_cards.set(card_id, card);
                    // reload checklists
                    fetchTrelloSourceChecklists(card_id);
                    console.log(`card (id:${card_id}) is reloaded.`);
                }
            }
            return trello_cards.get(card_id);
        }

        const fetchTrelloSourceChecklists = async (card_id) => {
            console.info('called fetchTrelloSourceChecklists()');
            if (!(Trello && Trello.token())) {
                console.error('Trello authorization incomplete.');
                return;
            }
            const card = trello_cards.get(card_id);
            const checklists = await Trello.rest('get', `cards/${card_id}/checklists`);
            const etag = Date.now();
            card.data.checklists = {
                etag: etag,
                data: new Map()
            };
            checklists.map(checklist=>{
                card.data.checklists.data.set(checklist.id, checklist);
            });
            trello_cards.set(card_id, card);
        }

        const getParentList = (card_id) => {
            console.info('called getParentList()');
            const card = trello_cards.get(card_id) || null;
            let list, p = [];
            if(card){
                list = card.data.checklists || null;
            }
            if(list){
                p = [...list.data.values()].filter(v=> v.name === PARENT_LIST_NAME);
            }
            return p[0] || {
                id: null,
                checkItems: []
            };
        }

        const getChildList = (card_id) => {
            console.info('called getChildList()');
            const card = getTrelloCard(card_id) || null;
            let list, p = [];
            if (card) {
                list = card.checklists || null;
            }
            if (list) {
                p = [...list.data.values()].filter(v=> v.name === CHILD_LIST_NAME);
            }
            return p[0] || {
                id: null,
                checkItems: []
            };
        }

        const addNodeChildList = (check_items) => {
            console.log('called addNodeChildList()');
            if(!Array.isArray(check_items)) {
                return true;
            }
            check_items.forEach(check_item=>{
                let container = $('#container_main_actions_child_task_template').clone(false);
            });
        }

        const onDropdownStart = async (element) => {
            const instance = M.Dropdown.getInstance(element);
            switch ($(instance.el).data('trello-type')) {
                case 'board':
                    onOpenDropdownBoard(instance);
                    break;
                case 'list':
                    onOpenDropdownList(instance);
                    break;
                case 'card':
                    onOpenDropdownCard(instance);
                    break;
                default:
                    break;
            }
            console.log(instance);
        }

        const getTrelloBoard = (board_id) => {
            return trello_boards.data.find(element=>element.id === board_id);
        }

        const getTrelloList = (list_id) => {
            const list = trello_lists.get(list_id);
            return list && list.data;
        }

        const getTrelloCard = (card_id) => {
            const card = trello_cards.get(card_id);
            return card && card.data;
        }

        const onOpenDropdownBoard = (dd_instance) => {
            console.log('called onOpenDropdownBoard()');
            const dd_element = $(dd_instance.dropdownEl);
            const source_etag = dd_element.data('source-etag');
            if(trello_boards.etag === "" || source_etag !== trello_boards.etag){
                dd_element.data('board-id', '');
                dd_element.children().each((index, dom) => {
                    if (dom) {
                        $(dome).off('click');
                    }
                });
                dd_element.empty();
                trello_boards.data.map((board) => {
                    console.log(board);
                    let li = document.createElement('li');
                    $(li).data('board-id', board.id);
                    $(li).click(()=>switchToBoard(li, dd_instance));
                    let a = document.createElement('a');
                    $(a).html(board.name);
                    $(li).append(a).appendTo(dd_element);
                });
                dd_instance.recalculateDimensions();
                dd_element.data('source-etag', trello_boards.etag);
            }
        }

        const switchToBoard = (board_element, dd_instance) => {
            console.log('called switchToBoard()');
            const dd_element = $(dd_instance.dropdownEl);
            const dd_button = $(dd_instance.el);
            const assoc_list_dd_button = $('.trello-list-container').find(`a.dropdown-trigger[data-associated-dropdown="${dd_element.attr('id')}"]`);
            const assoc_list_dd_instance = assoc_list_dd_button && M.Dropdown.getInstance(assoc_list_dd_button) || null;
            const board_id = board_element && $(board_element).data('board-id') || null;
            const board = board_id && getTrelloBoard(board_id) || null;
            // no board selected
            if(!board_element){
                $(dd_button).html('select board');
                dd_element.data('board-id', '');
                dd_element.children().each((index, dom) => {
                    if (dome) {
                        $(dome).off('click');
                    }
                });
                dd_element.empty();
                dd_instance.recalculateDimensions();
                if(assoc_list_dd_instance){
                    switchToList(null, assoc_list_dd_instance);
                }
                return;
            }
            dd_element.data('board-id', board_id);
            $(dd_button).html(`board: ${board.name}`);
            fetchTrelloSourceLists(board_id);
            //board switched
            if(assoc_list_dd_instance && $(assoc_list_dd_instance.el).data('board-id') !== board_id){
                switchToList(null, assoc_list_dd_instance);
                $(assoc_list_dd_instance.el).data('board-id', board_id);
            }
        }

        const onOpenDropdownList = (dd_instance) => {
            console.log('called onOpenDropdownList()');
            const dd_element = $(dd_instance.dropdownEl);
            const dd_button = $(dd_instance.el);
            const board_id = dd_button.data('board-id');
            let board_lists = [];
            if(dd_element.find('li').length === 0) {
                trello_lists.forEach((item) => {
                    if (item.data.idBoard === board_id) {
                        board_lists.push(item.data);
                    }
                });
                board_lists.map((item) => {
                    console.log(item);
                });
                board_lists.map((list) => {
                    let li = document.createElement('li');
                    $(li).data('list-id', list.id);
                    $(li).data('board-id', list.idBoard);
                    $(li).click(() => switchToList(li, dd_instance));
                    let a = document.createElement('a');
                    $(a).html(list.name);
                    $(li).append(a).appendTo(dd_element);
                });
                dd_instance.recalculateDimensions();
            }
        }

        const switchToList = (list_element, dd_instance) => {
            console.log('called switchToList()');
            const dd_element = $(dd_instance.dropdownEl);
            const dd_button = $(dd_instance.el);
            const assoc_card_dd_button = $('.trello-card-container').find(`a.dropdown-trigger[data-associated-dropdown="${dd_element.attr('id')}"]`);
            const assoc_card_dd_instance = assoc_card_dd_button && M.Dropdown.getInstance(assoc_card_dd_button) || null;
            const list_id = list_element && $(list_element).data('list-id') || null;
            const list = list_id && getTrelloList(list_id) || null;
            // no list selected
            if (!list_element) {
                $(dd_button).html('select list');
                dd_element.data('list-id', '');
                dd_element.children().each((index, dom) => {
                    if(dom){
                        $(dom).off('click');
                    }
                });
                dd_element.empty();
                dd_instance.recalculateDimensions();
                if (assoc_card_dd_instance) {
                    switchToCard(null, assoc_card_dd_instance);
                }
                return;
            }
            dd_element.data('list-id', list_id);
            $(dd_button).html(`list: ${list.name}`);
            fetchTrelloSourceCards(list_id);
            //list switched
            if (assoc_card_dd_instance && $(assoc_card_dd_instance.el).data('list-id') !== list_id) {
                switchToCard(null, assoc_card_dd_instance);
                $(assoc_card_dd_instance.el).data('list-id', list_id);
            }
        }

        const onOpenDropdownCard = (dd_instance) => {
            console.log('called onOpenDropdownCard()');
            const dd_element = $(dd_instance.dropdownEl);
            const dd_button = $(dd_instance.el);
            const list_id = dd_button.data('list-id');
            let list_cards = [];
            if (dd_element.find('li').length === 0) {
                trello_cards.forEach((item) => {
                    if (item.data.idList === list_id) {
                        list_cards.push(item.data);
                    }
                });
                list_cards.map((item) => {
                    console.log(item);
                });
                list_cards.map((card) => {
                    let li = document.createElement('li');
                    $(li).data('card-id', card.id);
                    $(li).data('list-id', card.idList);
                    $(li).click(() => switchToCard(li, dd_instance));
                    let a = document.createElement('a');
                    $(a).html(card.name);
                    $(li).append(a).appendTo(dd_element);
                });
                dd_instance.recalculateDimensions();
            }
        }

        const switchToCard = async (card_element, dd_instance) => {
            console.log('called switchToCard()');
            const dd_element = $(dd_instance.dropdownEl);
            const dd_button = $(dd_instance.el);
            const card_id = card_element && $(card_element).data('card-id') || null;
            const card = card_id && getTrelloCard(card_id) || null;
            // no card selected
            if (!card_element) {
                $(dd_button).html('select card');
                dd_element.data('card-id', '');
                dd_element.children().each((index, dom) => {
                    if (dom) {
                        $(dom).off('click');
                    }
                });
                dd_element.empty();
                dd_instance.recalculateDimensions();
                return;
            }
            dd_element.data('card-id', card_id);
            $(dd_button).html(`card: ${card.name}`);
            await fetchTrelloSourceChecklists(card_id);
            await updateParentTaskList(card_id);
            updateChildTaskList(card_id);
        }

        const updateParentTaskList = async (card_id) => {
            console.log('called updateParentTaskList()');
            const parent_list = getParentList(card_id);;
            if(!parent_list.id){
                $('#action_open_main_parent_task').data('url', '');
                return;
            }
            $('#action_open_main_parent_task').data('url', parent_list.name);
        }

        const updateChildTaskList = async (card_id) => {
            console.log('called updateChildTaskList()');
            const card = getTrelloCard(card_id);
            const child_list = getChildList(card_id);
            const main_node_root = $('#container_main_checklist_child_task');
            const main_node_card_id = $(main_node_root).data('card-id');
            // compare the child list with the nodes in the current list
            // clear if card id are different
            if(main_node_card_id != card_id){
                main_node_root.find('div[data-type="child_task"]').each((index, dom)=>{
                    $(dom).find('.clickable').each((index1, dom1) => {
                            if (dom1) {
                                $(dom1).off('click');
                            }
                        }
                    );
                });
                main_node_root.empty();
            }
            let current_nodes = $('#container_main_checklist_child_task');
            child_list.checkItems.forEach(check_item => {
                if($('#container_main_checklist_child_task')
                    .children(`div[data-card-id="${card_id}"]`).length > 0) {
                        return;
                }
                let container = $('#container_main_actions_child_task_template').clone(false);
                container.data('card-id', card_id).removeClass('hide').addClass('show');
                container.find('input[data-type="url"]').val(check_item.name);
                container.find('input[data-type="done"]')
                    .prop('checked', check_item.state === 'complete')
                    .data('card-id', card_id)
                    .data('check-item-id', check_item.id)
                    .click(async (event) => {
                        console.log($(event.target));
                    });
                let row = document.createElement('div');
                $(row).addClass('col s12');
                $(row).append(container);
                main_node_root.append(row);
            });
            main_node_root.data('card-id', card_id);
        }

        const setCheckItemState = async (card_id, check_item_id, done = false) => {
            return await Trello.rest('post',
                `cards/${card_id}/checkItem/${check_item_id}`,
                {
                    state: done && 'complete' || 'incomplete'
                });
        }

        const validateTrimesEndpointUrl = ()=>{
            if ($('#input_trimes_endpoint_url').val() === '') {
                $('#input_trimes_endpoint_url').val('https://');
            }
            if ($('#input_trimes_endpoint_url').val() === 'https://') {
                return false;
            }
            return true;
        }

        const getActiveCard = (side = 'main')=> {
            const side_name = side === 'link' && link || 'main';
            const card_id =  $(`#dd_${side_name}_card`).data('card-id');
            return getTrelloCard(card_id);
        }

        const addChildTask = async ()=>{
            console.log('called addChildTask()');
            const child_task_url = String($('#template_input_main_child_task_url').val()).trim();
            if(child_task_url ===''){
                M.toast({ html: 'Child Task url is required!' });
                return;
            }
            //NOTE: it won't validate the input against a url format
            let parent_card = getActiveCard('main');
            const parent_card_id = parent_card && parent_card.id;
            if (!parent_card_id) {
                M.toast({ html: 'Select a main card first!' });
                return;
            }
            // check wether the parent task already contain this child
            let child_list = getChildList(parent_card_id);
            let child_list_id = child_list && child_list.id;
            const filter_func = child => child && String(child.name).trim() === child_task_url;
            let existing_child = child_list.length > 0 &&
                child_list.checkItems.filter(filter_func) || [];
            // if no matching existing child, fetch the latest data from Trello and redo once
            if(existing_child.length === 0) {
                const remote_list = await Trello.rest('get', `cards/${parent_card_id}/checklists`);
                existing_child = remote_list.length > 0 &&
                    remote_list[0].checkItems.filter(filter_func);
            }

            if(existing_child.length !== 0) {
                M.toast({ html: 'Url exists as a child task already!' });
                return;
            }
            //if no child list, create one
            if(!child_list_id){
                let checklist = await Trello.rest('post', 'checklists', {
                    idCard: parent_card_id,
                    name: CHILD_LIST_NAME,
                    pos: '2'
                });
                //TODO: should validate the returned checklist
                console.log(`checklist: ${CHILD_LIST_NAME} is `+
                    `created on card (id: ${parent_card_id})`);
                await loadTrelloSourceCard(parent_card_id, '0');
                //refresh parent card and child list
                parent_card = getActiveCard('main');
                child_list = getChildList(parent_card_id);
                child_list_id = child_list && child_list.id;
            }
            //post new task
            let check_items = await Trello.rest('post',
                `checklists/${child_list_id}/checkItems`,
                {
                    name: child_task_url,
                    pos: 'bottom',
                    checked: 'false'
                });
            console.log(check_items);
            // reload checklists
            fetchTrelloSourceChecklists(parent_card_id);
            child_list = getChildList(parent_card_id);
            updateChildTaskList(parent_card_id);
        }

        const updateOpenUrlButton = (dom, url) => {
            const trimmed_url = String(url).trim();
            $(dom).data('url', trimmed_url);
            if(trimmed_url !== '') {
                $(dom).removeClass('hide').addClass('show');
            } else {
                $(dom).removeClass('show').addClass('hide');
            }
        }

        const saveInputs = () => {
            Cookies.set('cookies_trimes_endpoint_url', $('#input_trimes_endpoint_url').val());
        };

        const autoConnect = async () => {
            if (verifyCookiesConsent() && Cookies.get('trimesautoconnect') === 'true') {
                await connectToTrimesEndpoint();
            }
        }

        $('#cb_auto_connect').prop('checked', Cookies.get('trimesautoconnect') === 'true');

        await autoConnect();

        console.info('page loaded.');
    });
    </script>
</body>

</html>
